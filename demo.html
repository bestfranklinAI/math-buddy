<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Math Adventure!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            touch-action: none; /* Prevents default touch actions like scrolling */
            background-color: #0c0a1a;
            overflow: hidden;
        }

        @keyframes stars {
            0% { background-position: 0 0; }
            100% { background-position: 0 1000px; }
        }

        .stars-bg {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="transparent"/><circle cx="20" cy="20" r="1" fill="white"/><circle cx="50" cy="80" r="1" fill="white"/><circle cx="90" cy="30" r="1" fill="white"/><circle cx="70" cy="60" r="1" fill="white"/><circle cx="10" cy="90" r="0.5" fill="white"/></svg>');
            animation: stars 50s linear infinite;
        }
        
        .starfighter {
            width: 60px;
            height: 60px;
            position: relative;
            cursor: grab;
            user-select: none;
            transition: transform 0.2s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Simple X-Wing shape using CSS */
        .starfighter::before, .starfighter::after {
            content: '';
            position: absolute;
            background-color: #d1d5db; /* gray-300 */
            border-radius: 2px;
        }
        .starfighter::before {
            width: 100%;
            height: 15%;
        }
        .starfighter::after {
            width: 15%;
            height: 100%;
        }
        
        .starfighter.dragging {
            cursor: grabbing;
            z-index: 100;
            transform: scale(1.2) rotate(10deg);
        }

        .drop-zone {
            border: 4px dashed #3b82f6; /* blue-500 */
            background-color: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .planet-eater {
            width: 150px;
            height: 150px;
            background-color: #374151; /* gray-700 */
            border: 4px solid #1f2937; /* gray-800 */
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .planet-eater-mouth {
            width: 40px;
            height: 40px;
            background-color: #fca5a5; /* red-300 */
            border-radius: 50%;
            margin-top: 50px;
            box-shadow: 0 0 20px #ef4444;
            transition: transform 0.2s;
        }
        .planet-eater.eating .planet-eater-mouth {
            transform: scale(1.5);
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1.5); box-shadow: 0 0 20px #ef4444; }
            50% { transform: scale(1.7); box-shadow: 0 0 30px #f87171; }
        }

        .feedback-popup {
            animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="overflow-hidden stars-bg">

    <div id="game-container" class="w-full h-screen flex flex-col items-center justify-center p-4">
        <!-- Question Area -->
        <div id="question-area" class="text-center mb-4">
            <h1 id="question-title" class="text-3xl md:text-5xl font-bold text-cyan-300"></h1>
            <p id="question-instruction" class="text-lg md:text-2xl text-cyan-500 mt-2"></p>
        </div>

        <!-- Main Interactive Area -->
        <div id="interactive-area" class="relative w-full max-w-4xl h-96 bg-black bg-opacity-20 border-4 border-blue-800 rounded-2xl shadow-lg flex items-center justify-center p-4">
            <!-- Content will be generated by JS -->
        </div>

        <!-- Answer Buttons Area -->
        <div id="answer-area" class="mt-6 h-24 flex items-center justify-center space-x-4">
            <!-- Answer buttons will be generated by JS -->
        </div>
    </div>

    <!-- Feedback Popup -->
    <div id="feedback-popup" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="feedback-popup bg-gray-800 border-2 border-cyan-400 rounded-2xl p-8 text-center shadow-2xl max-w-sm w-full text-white">
            <div id="feedback-icon" class="text-8xl mb-4"></div>
            <h2 id="feedback-title" class="text-4xl font-bold"></h2>
            <p id="feedback-message" class="text-xl mt-2"></p>
            <button id="next-button" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition-transform transform hover:scale-105">Continue</button>
        </div>
    </div>

    <script>
        // --- GAME SETUP ---
        const questionArea = document.getElementById('question-area');
        const questionTitle = document.getElementById('question-title');
        const questionInstruction = document.getElementById('question-instruction');
        const interactiveArea = document.getElementById('interactive-area');
        const answerArea = document.getElementById('answer-area');
        const feedbackPopup = document.getElementById('feedback-popup');
        const feedbackIcon = document.getElementById('feedback-icon');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextButton = document.getElementById('next-button');

        // Sound synthesis for sci-fi feedback
        const correctSound = new Tone.Synth({
            oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }
        }).toDestination();
        const wrongSound = new Tone.Synth({
            oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.2 }
        }).toDestination();
        const popSound = new Tone.PluckSynth().toDestination();


        const questions = [
            {
                title: "What is 5 + 3?",
                instruction: "Assemble the fleet! Drag all starfighters to the mothership.",
                type: 'addition',
                items: [5, 3],
                correctAnswer: 8,
                answerOptions: [6, 8, 7, 9],
                setup: setupAddition,
            },
            {
                title: "If you have 12 fighters and lose 4, how many are left?",
                instruction: "A Planet Eater attacks! Drag 4 fighters to it. How many are left?",
                type: 'subtraction',
                initialItems: 12,
                itemsToRemove: 4,
                correctAnswer: 8,
                answerOptions: [8, 10, 7, 9],
                setup: setupSubtraction,
            }
        ];

        let currentQuestionIndex = 0;
        let draggedElement = null;

        // --- DRAG AND DROP LOGIC ---
        function makeDraggable(element) {
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag, { passive: false });
        }

        function startDrag(e) {
            e.preventDefault();
            if (e.target.closest('.starfighter')) {
                popSound.triggerAttackRelease('C4', '8n');
                draggedElement = e.target.closest('.starfighter');
                draggedElement.classList.add('dragging');
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            }
        }

        function drag(e) {
            if (!draggedElement) return;
            e.preventDefault();
            
            let x, y;
            if (e.type === 'touchmove') {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }

            const interactiveRect = interactiveArea.getBoundingClientRect();
            draggedElement.style.position = 'absolute';
            draggedElement.style.left = `${x - interactiveRect.left - draggedElement.offsetWidth / 2}px`;
            draggedElement.style.top = `${y - interactiveRect.top - draggedElement.offsetHeight / 2}px`;
        }

        function endDrag(e) {
            if (!draggedElement) return;

            const dropTarget = document.querySelector('.drop-zone');
            if (dropTarget) {
                const dropRect = dropTarget.getBoundingClientRect();
                const draggedRect = draggedElement.getBoundingClientRect();

                if (
                    draggedRect.left < dropRect.right &&
                    draggedRect.right > dropRect.left &&
                    draggedRect.top < dropRect.bottom &&
                    draggedRect.bottom > dropRect.top
                ) {
                    handleDrop(draggedElement, dropTarget);
                }
            }

            draggedElement.classList.remove('dragging');
            draggedElement = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
        }

        // --- UNIFIED DROP HANDLER ---
        function handleDrop(element, target) {
            const question = questions[currentQuestionIndex];
            
            if (question.type === 'addition') {
                const hangarContent = document.getElementById('hangar-content');
                if (element.parentElement !== hangarContent) {
                    target.querySelector('span').style.opacity = '0';
                    element.style.position = 'relative';
                    element.style.left = 'auto';
                    element.style.top = 'auto';
                    hangarContent.appendChild(element);
                    popSound.triggerAttackRelease('G4', '8n');
                }

                const totalFightersNeeded = question.items[0] + question.items[1];
                if (hangarContent.children.length === totalFightersNeeded) {
                    showAnswerOptions();
                }

            } else if (question.type === 'subtraction' && target.id === 'planet-eater') {
                const counter = document.getElementById('eater-counter');
                const eatenCount = parseInt(counter.dataset.count) + 1;
                
                if(eatenCount <= question.itemsToRemove) {
                    element.parentElement.removeChild(element);
                    target.classList.add('eating');
                    popSound.triggerAttackRelease('C3', '4n');
                    setTimeout(() => target.classList.remove('eating'), 500);
                    
                    counter.dataset.count = eatenCount;
                    counter.innerText = `Fighters lost: ${eatenCount}`;

                    if (eatenCount === question.itemsToRemove) {
                        showAnswerOptions();
                    }
                }
            }
        }

        // --- QUESTION 1: ADDITION SETUP ---
        function setupAddition() {
            interactiveArea.innerHTML = `
                <div class="flex w-full h-full items-center justify-around">
                    <div id="squad1" class="flex flex-wrap gap-2 p-2 justify-center items-center"></div>
                    <div class="text-6xl font-bold text-cyan-400">+</div>
                    <div id="squad2" class="flex flex-wrap gap-2 p-2 justify-center items-center"></div>
                </div>
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-3/4 h-1/2 drop-zone rounded-2xl flex items-center justify-center">
                    <div id="hangar-content" class="flex flex-wrap gap-2 p-4"></div>
                    <span class="text-2xl text-blue-400 font-bold opacity-50">Mothership Hangar</span>
                </div>
            `;
            const squad1 = document.getElementById('squad1');
            const squad2 = document.getElementById('squad2');
            
            for (let i = 0; i < questions[0].items[0]; i++) {
                const fighter = document.createElement('div');
                fighter.className = 'starfighter';
                squad1.appendChild(fighter);
                makeDraggable(fighter);
            }
            for (let i = 0; i < questions[0].items[1]; i++) {
                const fighter = document.createElement('div');
                fighter.className = 'starfighter';
                squad2.appendChild(fighter);
                makeDraggable(fighter);
            }
        }
        
        // --- QUESTION 2: SUBTRACTION SETUP ---
        function setupSubtraction() {
            interactiveArea.innerHTML = `
                <div id="fighter-group" class="w-2/3 h-full flex flex-wrap content-start gap-3 p-4"></div>
                <div class="absolute right-10 top-1/2 -translate-y-1/2 flex flex-col items-center">
                    <div id="planet-eater" class="planet-eater drop-zone">
                         <div class="planet-eater-mouth"></div>
                    </div>
                    <p id="eater-counter" data-count="0" class="text-xl font-bold text-red-400 mt-2">Fighters lost: 0</p>
                </div>
            `;
            const fighterGroup = document.getElementById('fighter-group');
            for(let i=0; i < questions[1].initialItems; i++) {
                const fighter = document.createElement('div');
                fighter.className = 'starfighter';
                fighterGroup.appendChild(fighter);
                makeDraggable(fighter);
            }
        }

        // --- GAME FLOW & UI ---
        function loadQuestion(index) {
            const question = questions[index];
            questionTitle.innerText = question.title;
            questionInstruction.innerText = question.instruction;
            interactiveArea.innerHTML = '';
            answerArea.innerHTML = '';
            question.setup();
        }

        function showAnswerOptions() {
            const question = questions[currentQuestionIndex];
            questionInstruction.innerText = "Excellent! Calculate the result, Commander!";
            
            const shuffledOptions = question.answerOptions.sort(() => Math.random() - 0.5);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = "bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-4 px-8 rounded-lg text-4xl transition-transform transform hover:scale-110 shadow-md border-2 border-yellow-600";
                button.innerText = option;
                button.onclick = () => checkAnswer(option);
                answerArea.appendChild(button);
            });
        }

        function checkAnswer(selectedAnswer) {
            const question = questions[currentQuestionIndex];
            if (selectedAnswer === question.correctAnswer) {
                correctSound.triggerAttackRelease('G5', '8n');
                showFeedback(true);
            } else {
                wrongSound.triggerAttackRelease('C3', '4n');
                showFeedback(false);
            }
        }

        function showFeedback(isCorrect) {
            if (isCorrect) {
                feedbackIcon.innerHTML = '&#128640;'; // Rocket emoji
                feedbackTitle.innerText = 'Mission Success!';
                feedbackMessage.innerText = "Your calculations are correct!";
                nextButton.innerText = 'Next Mission';
                nextButton.className = 'mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition-transform transform hover:scale-105';
            } else {
                feedbackIcon.innerHTML = '&#128165;'; // Explosion emoji
                feedbackTitle.innerText = 'Warning!';
                feedbackMessage.innerText = "Recalculate your strategy, Commander.";
                nextButton.innerText = 'Try Again';
                nextButton.className = 'mt-6 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition-transform transform hover:scale-105';
            }
            feedbackPopup.classList.remove('hidden');
            feedbackPopup.classList.add('flex');

            nextButton.onclick = () => {
                feedbackPopup.classList.add('hidden');
                feedbackPopup.classList.remove('flex');
                if (isCorrect) {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        loadQuestion(currentQuestionIndex);
                    } else {
                        showFinalScreen();
                    }
                }
            };
        }

        function showFinalScreen() {
            questionTitle.innerText = "You are a Fleet Admiral!";
            questionInstruction.innerText = "You have conquered all the math missions!";
            interactiveArea.innerHTML = `<div class="text-9xl">🚀⭐🏆</div>`;
            answerArea.innerHTML = '';
            const playAgainButton = document.createElement('button');
            playAgainButton.className = "bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-full text-3xl transition-transform transform hover:scale-110 shadow-md";
            playAgainButton.innerText = "New Campaign";
            playAgainButton.onclick = () => {
                currentQuestionIndex = 0;
                loadQuestion(currentQuestionIndex);
            };
            answerArea.appendChild(playAgainButton);
        }

        // --- INITIALIZE GAME ---
        window.onload = () => {
            document.body.addEventListener('click', () => Tone.start(), { once: true });
            loadQuestion(currentQuestionIndex);
        };
    </script>

</body>
</html>
